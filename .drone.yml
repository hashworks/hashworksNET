clone:
  git:
    image: plugins/git
    tags: true

pipeline:
  sass:
    image: codycraven/sassc
    pull: true
    commands:
      - sassc -t compressed sass/main.scss sass/main.css

  build:
    image: golang
    pull: true
    environment:
      - CGO_ENABLED=0
    commands:
      - go get -u github.com/UnnoTed/fileb0x
      - go generate --run "fileb0x"
      - go build -ldflags "-X main.VERSION=$(git describe --tags) -X main.BUILD_DATE=$(date --iso-8601=seconds) -X main.GIN_MODE=release" -o bin/hashworksNET *.go
      - go test --covermode=atomic --coverprofile=coverage.out ./server
      - ./bin/hashworksNET --version

  coverage:
    image: golang
    pull: true
    commands:
    - go tool cover --html=coverage.out -o=coverage.html
    - echo "Coverage report:" "$FILEBIN_BASE"/"$(curl -s "$FILEBIN_BASE"/api/v2.1.1/file/upload -F apikey="$FILEBIN_APIKEY" -F "file=@coverage.html" | cut -d \" -f 10)"
    secrets: [ filebin_base, filebin_apikey ]
    when:
      event: push

  deploy:
    image: rics3n/drone-ansible:2
    inventory: staging
    inventory_path: deployment/inventories
    playbook: deployment/deploy.yml
    secrets: [ ssh_key ]
    when:
      branch: master
      event: [push, tag, deployment]

  telegram:
    image: appleboy/drone-telegram
    pull: true
    format: markdown
    secrets: [telegram_to, telegram_token]
    when:
      event: [push, tag, deployment]
      status: [ changed, failure ]
    message: >
      *Build of {{repo.name}}/{{commit.branch}} {{#success build.status}}*[succeeded]({{build.link}}) ğŸ’ª{{else}}*[failed]({{build.link}}) ğŸ‘{{/success}}

      {{build.event}} from {{commit.author}}: [{{commit.message}}]({{commit.link}})