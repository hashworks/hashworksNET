clone:
  git:
    image: plugins/git
    tags: true

pipeline:
  sass:
    image: codycraven/sassc
    pull: true
    commands:
      - sassc -p 0 -t compressed sass/main.scss sass/main.css
      - sassc -p 0 -t compressed sass/chart.scss sass/chart.css

  build:
    image: golang
    pull: true
    environment:
      - CGO_ENABLED=0
    commands:
      - go get -u github.com/UnnoTed/fileb0x
      - go generate --run "fileb0x"
      - go build -ldflags "-X main.VERSION=$(git describe --tags) -X main.BUILD_DATE=$(date --iso-8601=seconds) -X main.GIN_MODE=release" -o bin/hashworksNET *.go
      - go test --covermode=atomic --coverprofile=coverage.out ./server
      - ./bin/hashworksNET --version

  coverage:
    image: golang
    pull: true
    commands:
    - if go tool cover --html=coverage.out -o=coverage.html; then
    -   if [ -f coverage.html ]; then echo "Coverage report:" "$FILEBIN_BASE"/"$(curl -s "$FILEBIN_BASE"/api/v2.1.1/file/upload -F apikey="$FILEBIN_APIKEY" -F "file=@coverage.html" | cut -d \" -f 10)"; fi
    - else
    -   return 1
    - fi
    secrets: [ filebin_base, filebin_apikey ]
    when:
      event: push

  deploy:
    image: rics3n/drone-ansible:2
    inventory: staging
    inventory_path: deployment/inventories
    playbook: deployment/deploy.yml
    secrets: [ ssh_key ]
    when:
      branch: master
      event: [push, tag, deployment]

  selenium:
    image: golang
    pull: true
    commands:
      - cd acception
      - if ! go test . --hub="selenium-chrome:4444" --url="https://hashworks.net/" --htmlPath acceptionTest.html --screenshotPath acceptionTest.png; then
      -   if [ -f acceptionTest.html ]; then echo "HTML:" "$FILEBIN_BASE"/"$(curl -s "$FILEBIN_BASE"/api/v2.1.1/file/upload -F apikey="$FILEBIN_APIKEY" -F "file=@acceptionTest.html" | cut -d \" -f 10)"; fi
      -   if [ -f acceptionTest.png ]; then echo "Screenshot:" "$FILEBIN_BASE"/"$(curl -s "$FILEBIN_BASE"/api/v2.1.1/file/upload -F apikey="$FILEBIN_APIKEY" -F "file=@acceptionTest.png" | cut -d \" -f 10)"; fi
      -   return 1
      - fi
    secrets: [ filebin_base, filebin_apikey ]
    when:
      branch: master
      event: [push, tag, deployment]

  restore:
    image: rics3n/drone-ansible:2
    inventory: staging
    inventory_path: deployment/inventories
    playbook: deployment/restore.yml
    secrets: [ ssh_key ]
    when:
      branch: master
      event: [push, tag, deployment]
      status: [ failure ]

  telegram:
    image: appleboy/drone-telegram
    pull: true
    format: markdown
    secrets: [telegram_to, telegram_token]
    when:
      event: [push, tag, deployment]
      status: [ changed, failure ]
    message: >
      *Build of {{repo.name}}/{{commit.branch}} {{#success build.status}}*[succeeded]({{build.link}}) ğŸ’ª{{else}}*[failed]({{build.link}}) ğŸ‘{{/success}}

      {{build.event}} from {{commit.author}}: [{{commit.message}}]({{commit.link}})

services:
  selenium-chrome:
    image: selenium/standalone-chrome
    pull: true
    environment:
      - HUB_HOST=selenium-chrome
    when:
      branch: master
      event: [push, tag, deployment]
